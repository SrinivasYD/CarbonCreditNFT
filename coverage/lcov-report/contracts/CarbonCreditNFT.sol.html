<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/CarbonCreditNFT.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> CarbonCreditNFT.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">96.3% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>26/27</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>16/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">97.14% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>34/35</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
&nbsp;
import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/utils/Pausable.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "./IAverageEmissionsOracle.sol";
import "./IProjectEmissionsOracle.sol";
import "./MockAverageEmissionsOracle.sol";
import "./MockProjectEmissionsOracle.sol";
&nbsp;
/**
 * @title CarbonCreditNFT
 * @dev An ERC721 token that represents carbon credits. Tokens are minted based on CO2 reduction calculations.
 */
contract CarbonCreditNFT is ERC721, Pausable, Ownable {
    uint256 public tokenCounter;
    IAverageEmissionsOracle public averageEmissionsOracle;
    IProjectEmissionsOracle public projectEmissionsOracle;
&nbsp;
    struct Project {
        address owner;
        string dataHash; // Off-chain data reference
        uint256 lastMintedTimestamp;
    }
&nbsp;
    mapping(uint256 =&gt; Project) public projects;
    uint256 public projectCounter;
&nbsp;
    /**
     * @dev Emitted when a new project is registered.
     * @param projectId The ID of the registered project.
     * @param owner The address of the project owner.
     * @param dataHash The hash of the off-chain data related to the project.
     */
    event ProjectRegistered(uint256 projectId, address owner, string dataHash);
&nbsp;
    /**
     * @dev Emitted when carbon credits are minted.
     * @param projectId The ID of the project for which the credits were minted.
     * @param recipient The address receiving the minted tokens.
     * @param numberOfTokens The number of tokens minted.
     * @param timestamp The timestamp when the tokens were minted.
     */
    event CarbonCreditsMinted(uint256 projectId, address recipient, uint256 numberOfTokens, uint256 timestamp);
&nbsp;
    /**
     * @dev Emitted for debugging purposes.
     * @param message The debug message.
     * @param value The associated value.
     */
    event DebugLog(string message, uint256 value);
&nbsp;
    /**
     * @dev Constructor for CarbonCreditNFT contract.
     * @param _averageEmissionsOracle The address of the average emissions oracle contract.
     * @param _projectEmissionsOracle The address of the project emissions oracle contract.
     */
    constructor(address _averageEmissionsOracle, address _projectEmissionsOracle)
        ERC721("CarbonCreditNFT", "CCNFT")
        Ownable(msg.sender)
    {
        tokenCounter = 0;
        projectCounter = 0;
        averageEmissionsOracle = IAverageEmissionsOracle(_averageEmissionsOracle);
        projectEmissionsOracle = IProjectEmissionsOracle(_projectEmissionsOracle);
    }
&nbsp;
    /**
     * @dev Registers a new project. Only callable when not paused.
     * @param dataHash The hash of the off-chain data related to the project.
     */
    function registerProject(string memory dataHash) public whenNotPaused {
        require(bytes(dataHash).length == 64, "Data hash must be a 64 character hex string");
        projects[projectCounter] = Project({
            owner: msg.sender,
            dataHash: dataHash,
            lastMintedTimestamp: 0
        });
        emit ProjectRegistered(projectCounter, msg.sender, dataHash);
        projectEmissionsOracle.registerProject(msg.sender);
        projectCounter++;
    }
&nbsp;
    /**
     * @dev Mints carbon credit tokens for a given project. Only callable by the project owner and when not paused.
     * @param recipient The address receiving the minted tokens.
     * @param projectId The ID of the project for which the tokens are being minted.
     */
    function mintCarbonCredit(address recipient, uint256 projectId) public <span class="missing-if-branch" title="else path not taken" >E</span>whenNotPaused {
        Project storage project = projects[projectId];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(project.owner == msg.sender, "Only the project owner can mint NFTs");
&nbsp;
        uint256 currentTime = block.timestamp;
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (project.lastMintedTimestamp != 0) {
<span class="cstat-no" title="statement not covered" >            require(currentTime &gt;= project.lastMintedTimestamp + 365 days, "NFTs can only be minted annually")</span>;
        }
&nbsp;
        uint256 energyProduced = projectEmissionsOracle.getEnergyProduced(msg.sender);
        uint256 projectEmissionsData = projectEmissionsOracle.getProjectEmissionsData(msg.sender);
        uint256 averageEmissionsFactor = averageEmissionsOracle.getAverageEmissionsFactor();
&nbsp;
        // Debugging logs
        emit DebugLog("During Transaction - Energy Produced", energyProduced);
        emit DebugLog("During Transaction - Project Emissions Data", projectEmissionsData);
        emit DebugLog("During Transaction - Average Emissions Factor", averageEmissionsFactor);
&nbsp;
        require(energyProduced &gt; 0, "Energy produced must be greater than zero");
        require(projectEmissionsData &lt; averageEmissionsFactor, "Project emissions are too high!");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(averageEmissionsFactor &gt; 0, "The average emissions factor is not updated by the oracle!");
&nbsp;
        uint256 co2Reduction = calculateCO2Reduction(energyProduced, averageEmissionsFactor, projectEmissionsData);
        uint256 numberOfTokens = co2Reduction / 1000000; // 1 token per tonne of CO2 (1 tonne = 1,000,000 grams)
        require(numberOfTokens &gt; 0, "No sufficient CO2 reduction for minting NFTs");
&nbsp;
        project.lastMintedTimestamp = currentTime;
&nbsp;
        for (uint256 i = 0; i &lt; numberOfTokens; i++) {
            _safeMint(recipient, tokenCounter);
            tokenCounter++;
        }
&nbsp;
        emit CarbonCreditsMinted(projectId, recipient, numberOfTokens, currentTime);
    }
&nbsp;
    /**
     * @dev Calculates the CO2 reduction based on energy produced and emissions data.
     * @param energyProduced The amount of energy produced by the project.
     * @param averageEmissionsFactor The average emissions factor from the oracle.
     * @param projectEmissionsData The emissions data for the project.
     * @return The calculated CO2 reduction in grams.
     */
    function calculateCO2Reduction(
        uint256 energyProduced,
        uint256 averageEmissionsFactor,
        uint256 projectEmissionsData
    ) internal pure returns (uint256) {
        // Calculate the difference in emissions and convert to grams of CO2 avoided
        uint256 avoidedEmissions = energyProduced * (averageEmissionsFactor - projectEmissionsData);
        return avoidedEmissions;
    }
&nbsp;
    /**
     * @dev Pauses the contract. Only callable by the owner.
     */
    function pause() public <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
        _pause();
    }
&nbsp;
    /**
     * @dev Unpauses the contract. Only callable by the owner.
     */
    function unpause() public <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
        _unpause();
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Jul 24 2024 22:13:24 GMT-0400 (Eastern Daylight Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
